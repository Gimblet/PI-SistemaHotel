@model List<Hotel.ViewModels.HabitacionFrontEnd>

@{
    ViewData["Title"] = "Habitaciones";
    var estadoColores = new Dictionary<int, string>
    {
        { 1, "bg-success bg-opacity-75 text-white" },
        { 3, "bg-info bg-opacity-75 text-dark" },
        { 4, "bg-secondary bg-opacity-75 text-white" }
    };
    string color(int estadoId,DateTime? fechaSalida)
    {
        if (estadoId == 2)
        {
            if (fechaSalida?.Date <= DateTime.Now.Date)
            {
                return "bg-warning text-dark";
            }
            else
            {
                return "bg-danger text-white";
            }
        }
        if (estadoColores.ContainsKey(estadoId))
        {
            return estadoColores[estadoId];
        }
        else
        {
            return "bg-secondary bg-opacity-50";
        }
    }
}
<br />
<div class="container mt-5">
    <h1>¡Hola @ViewBag.nombre, Bienvenido al Hotel Gol!</h1>
</div>

<form method="post" id="habitacionesForm">
    <div class="row g-4">
        @foreach (var habitacion in Model)
        {
            <div class="col-md-3 mb-4">
                <div class="card @color(habitacion.EstadoActualId, habitacion.fechaSalida)" id="habitacion_@habitacion.Id">
                    <div class="card-body d-flex mb-2" onclick="redirigirFormulario(@habitacion.Id)" style="cursor: pointer;">
                        <div class="col-md-9">
                            <div>
                                <h5 class="card-title">@habitacion.Numero</h5>
                                <p class="card-text"><strong>Tipo:</strong> @habitacion.TipoHabitacion</p>
                                <p class="card-text" id="salidaPrecio_@habitacion.Id" data-estado="@habitacion.EstadoActualId" data-fecha-salida="@habitacion.fechaSalida?.ToString("dd/MM/yyyy")" data-precio="@habitacion.precio.ToString("c")"></p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <img class="icono" src="@Url.Content("~/" + @habitacion.TipoHabitacion + "Icono.png")" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="EstadoActualId_@habitacion.Id">Estado</label>
                        @Html.DropDownListFor(model => habitacion.EstadoActualId,
                                    (SelectList)ViewBag.Estados,
                                    new { id = "EstadoActualId_" + habitacion.Id, @class = "form-control", onchange = "actualizarEstado(" + habitacion.Id + ")" })
                    </div>
                </div>
            </div>
        }
    </div>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        var habitaciones = document.querySelectorAll("[id^='salidaPrecio_']");

        habitaciones.forEach(function (habitacion) {
            var estado = habitacion.getAttribute("data-estado");
            var fechaSalida = habitacion.getAttribute("data-fecha-salida");
            var precio = habitacion.getAttribute("data-precio");

            if (estado == "2") {
                habitacion.innerHTML = "Salida " + fechaSalida;
            } else {
                habitacion.innerHTML = "Precio " + precio;
            }
        });

        $('.form-control').each(function () {
            var habitacionId = $(this).attr('id').split('_')[1];
            var estadoActualId = $(this).val();
            ajustarOpcionesEstado(habitacionId, estadoActualId);
        });
    });
    function actualizarEstado(habitacionId) {
        var estadoId = $('#EstadoActualId_' + habitacionId).val();

        ajustarOpcionesEstado(habitacionId, estadoId);

        var habitacionElement = $('#salidaPrecio_' + habitacionId);
        var fechaSalida = habitacionElement.data('fecha-salida');
        var precio = habitacionElement.data('precio');

        if (estadoId == "2") {
            habitacionElement.text("Salida " + fechaSalida);
        } else {
            habitacionElement.text("Precio " + precio);
        }

        $.ajax({
            url: '@Url.Action("ActualizarEstados", "Habitacion")', 
            type: 'POST',
            data: {
                habitacionId: habitacionId, 
                estadoId: estadoId          
            },
            success: function(response) {
                console.log('Estado actualizado correctamente.');
                actualizarColorHabitacion(habitacionId, estadoId);
            },
            error: function(error) {
                console.log('Error al actualizar el estado: ', error);
            }
        });
    }
    function redirigirFormulario(habitacionId) {
        var estadoId = $('#EstadoActualId_' + habitacionId).val();
        if (estadoId == 1) {
            window.location.href = '@Url.Action("RegistrarAlquiler", "Habitacion")?id=' + habitacionId;
        }
    }
    function actualizarColorHabitacion(habitacionId, estadoId) {
        var habitacionElement = $('#salidaPrecio_' + habitacionId);
        var fechaSalida = habitacionElement.data('fecha-salida');
        var fechaHoy = '@DateTime.Now.ToString("dd/MM/yyyy")';
        var estadoColores = {
            1: "bg-success bg-opacity-75 text-white",
            2: (fechaSalida <= fechaHoy) ? "bg-warning text-dark" : "bg-danger text-white",
            3: "bg-info bg-opacity-75 text-dark",
            4: "bg-secondary bg-opacity-75 text-white"
        };

        var color = estadoColores[estadoId] || "bg-secondary bg-opacity-75 text-white";
        $('#habitacion_' + habitacionId).removeClass().addClass('card ' + color);
    }
    function ajustarOpcionesEstado(habitacionId, estadoActualId) {
        var opcionesValidas = {
            1: [3, 4],
            2: [3, 4],
            3: [1, 4],
            4: [1, 3]
        };

        var selector = $('#EstadoActualId_' + habitacionId);
        var opciones = opcionesValidas[estadoActualId] || [];

        selector.find('option').each(function () {
            var opcionId = parseInt($(this).val());
            if (opciones.includes(opcionId)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    }
</script>
